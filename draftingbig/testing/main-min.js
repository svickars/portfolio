function generate_array(t){for(var a=0,r=0;r<dataset.length;r++)groupScale(dataset[r].group)==groupScale(t.group)&&categoryScale(dataset[r].category)<categoryScale(t.category)&&(a+=dataset[r].count/2);for(var e=new Array(t.count),o=0;o<t.count;o++)e[o]={y:groupScale(t.group),x:a+o/2,group:t.group,category:t.category,value:t.value};return e}dataset=[{group:"Grp 1",category:"Cat 1",count:1,value:9},{group:"Grp 1",category:"Cat 2",count:3,value:11},{group:"Grp 1",category:"Cat 3",count:5,value:.5},{group:"Grp 1",category:"Cat 4",count:4,value:5.6},{group:"Grp 2",category:"Cat 1",count:6,value:7.8},{group:"Grp 2",category:"Cat 2",count:2,value:8.9},{group:"Grp 3",category:"Cat 1",count:5,value:6.2},{group:"Grp 3",category:"Cat 2",count:4,value:1.1},{group:"Grp 4",category:"Cat 1",count:1,value:2.9},{group:"Grp 4",category:"Cat 3",count:4,value:3.2},{group:"Grp 4",category:"Cat 5",count:2,value:4.2},{group:"Grp 5",category:"Cat 2",count:6,value:11.1},{group:"Grp 5",category:"Cat 4",count:2,value:7.6},{group:"Grp 5",category:"Cat 5",count:1,value:8},{group:"Grp 6",category:"Cat 1",count:7,value:9.1},{group:"Grp 6",category:"Cat 2",count:3,value:4.2},{group:"Grp 6",category:"Cat 3",count:2,value:4.2},{group:"Grp 6",category:"Cat 4",count:1,value:5.6},{group:"Grp 6",category:"Cat 5",count:5,value:4.3},{group:"Grp 6",category:"Cat 6",count:3,value:.9}];var flags=[],unique_categories=[],unique_groups=[],l=dataset.length,i;for(i=0;i<l;i++)flags[dataset[i].category]||(flags[dataset[i].category]=!0,unique_categories.push(dataset[i].category));for(flags=[],i=0;i<l;i++)flags[dataset[i].group]||(flags[dataset[i].group]=!0,unique_groups.push(dataset[i].group));var groupScale=d3.scale.ordinal().domain(unique_groups).rangePoints([0,unique_groups.length-1]),categoryScale=d3.scale.ordinal().domain(unique_categories).rangePoints([0,unique_categories.length]),color=d3.scale.category20(),margin={top:20,right:50,bottom:50,left:150},width=800-margin.left-margin.right,height=400-margin.top-margin.bottom,xScale=d3.scale.linear().range([50,width]),yScale=d3.scale.linear().range([height,50]),xAxis=d3.svg.axis().scale(xScale).orient("bottom"),yAxis=d3.svg.axis().scale(yScale).orient("left").tickFormat(function(t){return unique_groups[t]}).ticks(unique_groups.length),result=dataset.reduce(function(t,a){return a.group in t?t[a.group].count+=a.count:t.__array.push(t[a.group]=a),t},{__array:[]}).__array.sort(function(t,a){return a.count-t.count});xScale.domain([0,result[0].count+4]),yScale.domain([0,d3.max(dataset,function(t){return groupScale(t.group)})]);var svg=d3.select("#chart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).attr("transform","translate("+margin.left+","+margin.top+")");svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("transform","translate(50,0)").attr("class","y axis").call(yAxis);var groups=svg.selectAll("g.group").data(dataset).enter().append("g").attr("class","group"),circleArray=groups.selectAll("g.circleArray").data(function(t){return generate_array(t)});circleArray.enter().append("g").attr("class","circleArray").append("circle").style("fill",function(t){return color(t.category)}).attr("r",function(t){return console.log(t),t.value}).attr("cx",function(t,a){return xScale(t.x)}).attr("cy",function(t,a){return yScale(t.y)});var legend=svg.selectAll(".legend").data(unique_categories).enter().append("g").attr("class","legend").attr("transform","translate(0,50)");legend.append("rect").attr("x",width-margin.right).attr("y",function(t,a){return 20*a}).attr("width",10).attr("height",10).style("fill",function(t){return color(t)}),legend.append("text").attr("x",width-margin.right+15).attr("y",function(t,a){return 20*a+10}).text(function(t){return t});var tooltip=d3.select("#chart").append("div").attr("class","tooltip");tooltip.append("div").attr("class","group"),tooltip.append("div").attr("class","category"),tooltip.append("div").attr("class","count"),svg.selectAll("circle").on("mouseover",function(t,a){tooltip.select(".group").html("<b>Group: "+t.group+"</b>"),tooltip.select(".category").html("<b>Category: "+t.category+"</b>"),tooltip.select(".count").html("<b>Count: "+t.x+"</b>"),tooltip.style("display","block"),tooltip.style("opacity",2)}).on("mousemove",function(t){tooltip.style("top",d3.event.layerY+10+"px").style("left",d3.event.layerX-25+"px")}).on("mouseout",function(){tooltip.style("display","none"),tooltip.style("opacity",0)});